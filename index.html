<!doctype html>
<html lang="en">
<head>

<meta charset="utf-8" />
<title>Goban</title>
<meta name="author" content="Yichuan Shen" />

<link rel="stylesheet" type="text/css" href="style/app.css" />
<link rel="stylesheet" type="text/css" href="style/goban.css" />
<script src="lib/mootools.js"></script>

</head>
<body>

<header>
    <span id="player_1">Black</span>
    <img src="img/blacktoplay.png" onload="this.draggable = false" />
    <span id="player_-1">White</span>
</header>

<section id="goban"></section>

<script>

var Tuple = require('./lib/tuple')
var Board = require('./class/board.js')
var form = require('remote').getCurrentWindow()

function getPlayerName(sign) {
    return $('player_' + sign).get('text')
}

function setPlayerName(sign, name) {
    $('player_' + sign).set('text', name)
}

function getCurrentPlayer() {
    return $$('header img').get('src') == 'img/blacktoplay.png' ? 1 : -1
}

function setCurrentPlayer(sign) {
    $$('header img').set('src', sign > 0 ? 'img/blacktoplay.png' : 'img/whitetoplay.png')
}

function getBoard() {
    return $('goban').retrieve('board')
}

function setBoard(board) {
    if (!getBoard() || getBoard().size != board.size) {
        buildBoard(board)
        resizeWindow()
    }

    for (var x = 0; x < board.size; x++) {
        for (var y = 0; y < board.size; y++) {
            var li = $('goban').getElement('.pos_' + x + '-' + y)
            var sign = board.arrangement[new Tuple(x, y)]

            li.removeClass('sign_0').removeClass('sign_1').removeClass('sign_-1')
                .addClass('sign_' + sign)
                .getElement('img').set('src', 'img/stone_' + sign + '.png')
        }
    }
}

function buildBoard(board) {
    var rows = []
    var hoshi = board.getHandicapPlacement(9)

    for (var x = 0; x < board.size; x++) {
        var ol = new Element('ol')

        for (var y = 0; y < board.size; y++) {
            var sign = board.arrangement[new Tuple(x, y)]
            var li = new Element('li.pos_' + x + '-' + y)

            var img = new Element('img', {
                src: 'img/stone_0.png',
                draggable: false
            })

            if (hoshi.some(function(v) { return v.equals(new Tuple(x, y)) }))
                li.addClass('hoshi')

            ol.adopt(li.adopt(img))
        }

        rows.push(ol)
    }

    $('goban').empty().adopt(rows)
}

function resizeWindow() {
    var width = $('goban').getSize().x
    var height = $('goban').getSize().y + $$('header')[0].getSize().y
    form.setContentSize(width, height)
}

document.addEvent('keydown', function(e) {
    if (e.code === 123) {
        form.toggleDevTools()
    } else if (e.code === 116) {
        location.reload()
    }
}).addEvent('domready', function() {
    setBoard(new Board(13))
    setTimeout(function() {
        setBoard(new Board())
    }, 1000)
    resizeWindow()
})

</script>

</body>
</html>