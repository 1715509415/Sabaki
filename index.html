<!doctype html>
<html lang="en">
<head>

<meta charset="utf-8" />
<title>Goban</title>
<meta name="author" content="Yichuan Shen" />

<link rel="stylesheet" type="text/css" href="style/app.css" />
<link rel="stylesheet" type="text/css" href="style/goban.css" />
<script src="lib/mootools.js"></script>

</head>
<body>

<header>
    <span id="player_1">Black</span>
    <img id="currentplayer" src="img/blacktoplay.png" onload="this.draggable = false" />
    <span id="player_-1">White</span>
    <img id="headermenu" src="img/menu.png" onload="this.draggable = false" onclick="openHeaderMenu()" />
</header>

<section id="goban"></section>

<script>

var remote = require('remote');
var sgf = require('./class/sgf.js')
var Menu = remote.require('menu');
var Tuple = require('./lib/tuple')
var Board = require('./class/board.js')

function getPlayerName(sign) {
    return $('player_' + sign).get('text')
}

function setPlayerName(sign, name) {
    $('player_' + sign).set('text', name)
}

function getCurrentPlayer() {
    return $('currentplayer').get('src') == 'img/blacktoplay.png' ? 1 : -1
}

function setCurrentPlayer(sign) {
    $('currentplayer').set('src', sign > 0 ? 'img/blacktoplay.png' : 'img/whitetoplay.png')
}

function getBoard() {
    return $('goban').retrieve('board')
}

function setBoard(board) {
    if (!getBoard() || getBoard().size != board.size) {
        buildBoard(board)
        resizeWindow()
    }

    for (var x = 0; x < board.size; x++) {
        for (var y = 0; y < board.size; y++) {
            var li = $('goban').getElement('.pos_' + x + '-' + y)
            var sign = board.arrangement[new Tuple(x, y)]

            li.removeClass('sign_0').removeClass('sign_1').removeClass('sign_-1')
                .addClass('sign_' + sign)
                .getElement('img').set('src', 'img/stone_' + sign + '.png')
        }
    }

    $('goban').store('board', board)
}

function positionClicked() {
    if (!this.hasClass('sign_0')) return

    setBoard(getBoard().makeMove(getCurrentPlayer(), this.retrieve('tuple')))
    setCurrentPlayer(-getCurrentPlayer())
}

function buildBoard(board) {
    var rows = []
    var hoshi = board.getHandicapPlacement(9)

    for (var x = 0; x < board.size; x++) {
        var ol = new Element('ol')

        for (var y = 0; y < board.size; y++) {
            var sign = board.arrangement[new Tuple(x, y)]
            var li = new Element('li.pos_' + x + '-' + y).store('tuple', new Tuple(x, y))

            var img = new Element('img', {
                src: 'img/stone_0.png',
                draggable: false
            }).addEvent('click', positionClicked.bind(li))

            if (hoshi.some(function(v) { return v.equals(new Tuple(x, y)) }))
                li.addClass('hoshi')

            ol.adopt(li.adopt(img))
        }

        rows.push(ol)
    }

    $('goban').empty().adopt(rows)
}

function buildMenu() {
    var template = [
        {
            label: '&Game',
            submenu: [
                {
                    label: '&New',
                    accelerator: 'CmdOrCtrl+N'
                },
                {
                    label: '&Load...',
                    accelerator: 'CmdOrCtrl+O'
                },
                { type: 'separator' },
                {
                    label: '&Save',
                    accelerator: 'CmdOrCtrl+S'
                },
                {
                    label: 'Save &As...',
                    accelerator: 'CmdOrCtrl+Shift+N'
                },
                { type: 'separator' },
                {
                    label: '&Info',
                    accelerator: 'CmdOrCtrl+I'
                }
            ]
        },
        {
            label: '&Navigation',
            submenu: [
                {
                    label: '&Back',
                    accelerator: 'CmdOrCtrl+Left'
                },
                {
                    label: '&Forward',
                    accelerator: 'CmdOrCtrl+Right'
                },
                {
                    label: 'Go To &Beginning',
                    accelerator: 'CmdOrCtrl+Home'
                },
                {
                    label: 'Go To &End',
                    accelerator: 'CmdOrCtrl+End'
                },
                { type: 'separator' },
                {
                    label: 'Go To Move...',
                    accelerator: 'CmdOrCtrl+G'
                },
            ]
        },
        {
            label: '&View',
            submenu: [
                {
                    label: 'Show &Coordinates',
                    accelerator: 'CmdOrCtrl+C'
                },
                {
                    label: 'Show &Variations',
                    accelerator: 'CmdOrCtrl+V'
                },
                { type: 'separator' },
                {
                    label: 'Show &History',
                    accelerator: 'CmdOrCtrl+H'
                }
            ]
        },
        {
            label: '&Help',
            submenu: [
                {
                    label: '&About Goban'
                }
            ]
        }
    ]

    var menu = Menu.buildFromTemplate(template)
    Menu.setApplicationMenu(menu)
}

function resizeWindow() {
    var width = $('goban').getSize().x
    var height = $('goban').getSize().y + $$('header')[0].getSize().y
    remote.getCurrentWindow().setContentSize(width, height)
}

function openHeaderMenu() {
    var template = [
        {
            label: '&Pass'
        },
        {
            label: '&Count...'
        },
        { type: 'separator' },
        {
            label: '&Info'
        }
    ]

    menu = Menu.buildFromTemplate(template)
    menu.popup(remote.getCurrentWindow(), $('headermenu').getPosition().x, $$('header')[0].getSize().y)
}

document.addEvent('keydown', function(e) {
    if (e.code === 123) {
        remote.getCurrentWindow().toggleDevTools()
    } else if (e.code === 116) {
        location.reload()
    }
}).addEvent('domready', function() {
    buildMenu()
    setBoard(new Board())
    resizeWindow()

    var tree = sgf.parseFile("C:\\Users\\Yichuan\\OneDrive\\Dokumente\\Kifu\\Pro\\legend88.sgf")
    var json = JSON.encode(tree['subtrees'][0])
})

</script>

</body>
</html>