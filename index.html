<!doctype html>
<html lang="en">
<head>

<meta charset="utf-8" />
<title>Goban</title>
<meta name="author" content="Yichuan Shen" />

<link rel="stylesheet" type="text/css" href="style/app.css" />
<link rel="stylesheet" type="text/css" href="style/goban.css" />
<script src="lib/mootools.js"></script>

</head>
<body>

<section id="goban"></section>

<header>
    <span id="player_1">Black</span>
    <img id="currentplayer" src="img/blacktoplay.png" onload="this.draggable = false" />
    <span id="player_-1">White</span>
    <img id="headermenu" src="img/menu.png" onload="this.draggable = false" onclick="openHeaderMenu()" />
</header>

<script>

var remote = require('remote')
var dialog = remote.require('dialog')
var sgf = require('./class/sgf.js')
var Menu = remote.require('menu')
var Tuple = require('./lib/tuple')
var Board = require('./class/board.js')

function getShowVariations() {
    return $('goban').retrieve('showVariations')
}

function setShowVariations(show) {
    $('goban').store('showVariations', show)
}

function getPlayerName(sign) {
    return $('player_' + sign).get('text')
}

function setPlayerName(sign, name) {
    $('player_' + sign).set('text', name)
}

function getCurrentPlayer() {
    return $('currentplayer').get('src') == 'img/blacktoplay.png' ? 1 : -1
}

function setCurrentPlayer(sign) {
    $('currentplayer').set('src', sign > 0 ? 'img/blacktoplay.png' : 'img/whitetoplay.png')
}

function getTree() {
    return $('goban').retrieve('tree')
}

function setTree(tree) {
    $('goban').store('tree', tree)

    if (tree.nodes.length == 0) return
    setCurrentTreePosition(tree, 0)

    if ('PB' in tree.nodes[0]) setPlayerName(1, tree.nodes[0].PB[0])
    if ('PW' in tree.nodes[0]) setPlayerName(-1, tree.nodes[0].PW[0])
}

function setCurrentTreePosition(tree, position) {
    $('goban').store('position', new Tuple(tree, position))
    setBoard(sgf.addBoards(tree).nodes[position].board)
    setCurrentPlayer(1)

    if ('B' in tree.nodes[position]) setCurrentPlayer(-1)
    else if ('W' in tree.nodes[position]) setCurrentPlayer(1)
    else if ('PL' in tree.nodes[position])
        setCurrentPlayer(tree.nodes[position].PL[0] == 'W' ? -1 : 1)
    else if ('HA' in tree.nodes[position]) setCurrentPlayer(-1)
}

function getCurrentTreePosition() {
    return $('goban').retrieve('position')
}

function getBoard() {
    return $('goban').retrieve('board')
}

function setBoard(board) {
    if (!getBoard() || getBoard().size != board.size) {
        buildBoard(board)
        resizeWindow()
    }

    for (var x = 0; x < board.size; x++) {
        for (var y = 0; y < board.size; y++) {
            var li = $('goban').getElement('.pos_' + x + '-' + y)
            var sign = board.arrangement[new Tuple(x, y)]

            if (li.hasClass('sign_' + sign)) continue

            li.removeClass('sign_0').removeClass('sign_1').removeClass('sign_-1')
                .addClass('sign_' + sign)
                .getElement('img').set('src', 'img/stone_' + sign + '.png')
        }
    }

    $('goban').store('board', board)
}

function positionClicked() {
    if (!this.hasClass('sign_0')) return

    setBoard(getBoard().makeMove(getCurrentPlayer(), this.retrieve('tuple')))
    setCurrentPlayer(-getCurrentPlayer())
}

function buildBoard(board) {
    var rows = []
    var hoshi = board.getHandicapPlacement(9)

    for (var y = 0; y < board.size; y++) {
        var ol = new Element('ol')

        for (var x = 0; x < board.size; x++) {
            var sign = board.arrangement[new Tuple(y, x)]
            var li = new Element('li.pos_' + x + '-' + y).store('tuple', new Tuple(x, y))

            var img = new Element('img', {
                src: 'img/stone_0.png',
                draggable: false
            }).addEvent('click', positionClicked.bind(li))

            if (hoshi.some(function(v) { return v.equals(new Tuple(x, y)) }))
                li.addClass('hoshi')

            ol.adopt(li.adopt(img))
        }

        rows.push(ol)
    }

    $('goban').empty().adopt(rows)
}

function goBack() {
    getCurrentTreePosition().unpack(function(tree, position) {
        if (position - 1 >= 0) {
            setCurrentTreePosition(tree, position - 1)
        } else if (tree.parent != null && tree.parent.nodes.length != 0) {
            setCurrentTreePosition(tree.parent, tree.parent.nodes.length - 1)
        }
    })
}

function goForward() {
    getCurrentTreePosition().unpack(function(tree, position) {
        if (tree.nodes.length > position + 1) {
            setCurrentTreePosition(tree, position + 1)
        } else if (tree.current != null && tree.subtrees[tree.current].nodes.length != 0) {
            setCurrentTreePosition(tree.subtrees[tree.current], 0)
        }
    })
}

function goToBeginning() {
    var tree = getTree()
    if (tree.nodes.length == 0) return
    setCurrentTreePosition(tree, 0)
}

function goToEnd() {
    getCurrentTreePosition().unpack(function(tree, position) {
        var t = tree
        while (t.current != null) {
            t = t.subtrees[t.current]
        }
        setCurrentTreePosition(t, t.nodes.length - 1)
    })
}

function loadGame() {
    var filename = dialog.showOpenDialog(remote.getCurrentWindow(), {
        filters: [{ name: 'SGF Files', extensions: ['sgf'] }]
    })[0]
    var tree = sgf.parseFile(filename)
    if (tree.subtrees.length == 0) return
    setTree(tree.subtrees[0])
}

function buildMenu() {
    setShowVariations(true)

    var template = [
        {
            label: '&Game',
            submenu: [
                {
                    label: '&New',
                    accelerator: 'CmdOrCtrl+N'
                },
                {
                    label: '&Load...',
                    accelerator: 'CmdOrCtrl+O',
                    click: loadGame
                },
                { type: 'separator' },
                {
                    label: '&Save',
                    accelerator: 'CmdOrCtrl+S'
                },
                {
                    label: 'Save &As...',
                    accelerator: 'CmdOrCtrl+Shift+S'
                },
                { type: 'separator' },
                {
                    label: '&Info',
                    accelerator: 'CmdOrCtrl+I'
                }
            ]
        },
        {
            label: '&Navigation',
            submenu: [
                {
                    label: '&Back',
                    accelerator: 'Left',
                    click: goBack
                },
                {
                    label: '&Forward',
                    accelerator: 'Right',
                    click: goForward
                },
                { type: 'separator' },
                {
                    label: 'Go To &Beginning',
                    accelerator: 'CmdOrCtrl+Home',
                    click: goToBeginning
                },
                {
                    label: 'Go To &End',
                    accelerator: 'CmdOrCtrl+End',
                    click: goToEnd
                },
                { type: 'separator' },
                {
                    label: 'Go Back To &Fork'
                },
                {
                    label: 'Go To &Next Fork'
                }
            ]
        },
        {
            label: '&View',
            submenu: [
                {
                    label: 'Show &Coordinates',
                    accelerator: 'CmdOrCtrl+C'
                },
                {
                    label: 'Show &Variations',
                    accelerator: 'CmdOrCtrl+V',
                    type: 'checkbox',
                    checked: getShowVariations(),
                    click: function() {
                        setShowVariations(!getShowVariations())
                        setBoard(getBoard())
                    }
                },
                { type: 'separator' },
                {
                    label: 'Show &History',
                    accelerator: 'CmdOrCtrl+H'
                }
            ]
        },
        {
            label: '&Help',
            submenu: [
                {
                    label: '&About Goban'
                }
            ]
        }
    ]

    Menu.setApplicationMenu(Menu.buildFromTemplate(template))
}

function openHeaderMenu() {
    var template = [
        {
            label: '&Pass'
        },
        {
            label: '&Resign'
        },
        {
            label: '&Count...'
        },
        { type: 'separator' },
        {
            label: '&Info'
        }
    ]

    menu = Menu.buildFromTemplate(template)
    menu.popup(remote.getCurrentWindow(), $('headermenu').getPosition().x, $$('header')[0].getCoordinates().top)
}

function resizeWindow() {
    var width = $('goban').getSize().x
    var height = $('goban').getSize().y + $$('header')[0].getSize().y
    remote.getCurrentWindow().setContentSize(width, height)
}

document.addEvent('keydown', function(e) {
    if (e.code === 123) {
        remote.getCurrentWindow().toggleDevTools()
    } else if (e.code === 116) {
        location.reload()
    }
}).addEvent('mousewheel', function(e) {
    if (e.wheel < 0) goForward()
    else if (e.wheel > 0) goBack()
}).addEvent('domready', function() {
    buildMenu()
    setBoard(new Board())
    resizeWindow()
})

</script>

</body>
</html>