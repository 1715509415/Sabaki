<!doctype html>
<html lang="en">
<head>

<meta charset="utf-8" />
<title>Goban</title>
<meta name="author" content="Yichuan Shen" />

<link rel="stylesheet" type="text/css" href="../style/app.css" />
<link rel="stylesheet" type="text/css" href="../style/goban.css" />
<link rel="stylesheet" type="text/css" href="../style/index.css" />
<script src="../lib/mootools.js"></script>

</head>
<body>

<section id="main">
    <section id="goban" class="goban"></section>

    <section id="bar">
        <section id="edit">
            <ul>
                <li class="selected stone-tool"><a href="#" title="Stone Tool"><img src="../img/edit/stone_1.png" /></a></li>
                <li class="cross-tool"><a href="#" title="Cross Tool"><img src="../img/edit/cross.png" /></a></li>
                <li class="triangle-tool"><a href="#" title="Triangle Tool"><img src="../img/edit/triangle.png" /></a></li>
                <li class="square-tool"><a href="#" title="Square Tool"><img src="../img/edit/square.png" /></a></li>
                <li class="circle-tool"><a href="#" title="Circle Tool"><img src="../img/edit/circle.png" /></a></li>
                <li class="label-tool"><a href="#" title="Label Tool"><img src="../img/edit/label.png" /></a></li>
                <li class="number-tool"><a href="#" title="Number Tool"><img src="../img/edit/number.png" /></a></li>
            </ul>
        </section>
        <header>
            <span id="player_1"><span class="captures">0</span> <span class="name">Black</span></span>
            <img class="currentplayer" src="../img/ui/blacktoplay.png" />
            <span id="player_-1"><span class="name">White</span> <span class="captures">0</span></span>
            <img id="headermenu" src="../img/ui/menu.png" onclick="openHeaderMenu()" />
        </header>
    </section>

    <section id="info">
        <div class="gm-scrollbar -vertical">
            <div class="thumb"></div>
        </div>
        <div class="gm-scrollbar -horizontal">
            <div class="thumb"></div>
        </div>
        <div class="gm-scroll-view">
            <form>
                <section>
                    <input type="text" name="rank_1" placeholder="Rank" />
                    <input type="text" name="name_1" placeholder="Player Black" />
                    <img class="currentplayer" src="../img/ui/blacktoplay.png" onload="this.draggable = false" />
                    <input type="text" name="name_-1" placeholder="Player White" />
                    <input type="text" name="rank_-1" placeholder="Rank" />
                </section>

                <ul>
                    <li>
                        <label><span>Result:</span>
                        <input type="text" name="result" placeholder="None" /></label>
                    </li>
                    <li>
                        <label><span>Komi:</span>
                        <input type="text" name="komi" placeholder="0" /></label>
                    </li>
                    <li>
                        <label><span>Handicap:</span>
                        <select name="handicap">
                            <option>No stones</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                            <option>5</option>
                            <option>6</option>
                            <option>7</option>
                            <option>8</option>
                            <option>9</option>
                        </select></label>
                    </li>
                    <li>
                        <label><span>Board size:</span>
                        <input type="number" name="size" placeholder="19" max="26" min="9" /></label>
                    </li>
                </ul>

                <p>
                    <button type="submit" onclick="updateGameInfo(); closeGameInfo(); return false">OK</button>
                    <button type="reset" onclick="closeGameInfo(); return false">Cancel</button>
                </p>
            </form>
        </div>
    </section>
</section>

<section id="loading"></section>

<script>
    var remote = require('remote')
    var process = remote.require('process')
    var app = remote.require('app');
    var dialog = remote.require('dialog')
    var fs = require('fs')
    var sgf = require('../module/sgf.js')
    var setting = remote.require('./module/setting.js')

    var Menu = remote.require('menu')
    var Tuple = require('../lib/tuple')
    var Board = require('../module/board.js')
    var Scrollbar = require('../lib/gemini-scrollbar')

    /**
     * Methods
     */

    function loadSettings() {
        if (setting.get('view.fuzzy_stone_placement'))
            $('goban').addClass('fuzzy')
        if (setting.get('view.show_coordinates'))
            $('goban').addClass('coordinates')
        if (setting.get('view.show_variations'))
            $('goban').addClass('variations')
    }

    function setIsLoading(loading) {
        if (loading) document.body.addClass('loading')
        else $('loading').tween('opacity', 0).get('tween').addEvent('complete', function() {
            document.body.removeClass('loading')
            $('loading').setStyle('opacity', null)
        })
    }

    function getShowVariations() {
        return $('goban').hasClass('variations')
    }

    function setShowVariations(show) {
        if (show) $('goban').addClass('variations')
        else $('goban').removeClass('variations')
        setting.set('view.show_variations', show)
    }

    function getFuzzyStonePlacement() {
        return $('goban').hasClass('fuzzy')
    }

    function setFuzzyStonePlacement(fuzzy) {
        if (fuzzy) $('goban').addClass('fuzzy')
        else $('goban').removeClass('fuzzy')
        setting.set('view.fuzzy_stone_placement', fuzzy)
    }

    function getShowCoordinates() {
        return $('goban').hasClass('coordinates')
    }

    function setShowCoordinates(show) {
        if (show) $('goban').addClass('coordinates')
        else $('goban').removeClass('coordinates')
        setting.set('view.show_coordinates', show)
    }

    function getPlayerName(sign) {
        return $$('#player_' + sign + ' .name')[0].get('text')
    }

    function setPlayerName(sign, name) {
        $$('#player_' + sign + ' .name')[0].set('text', name)
    }

    function getCaptures() {
        return {
            '-1': $$('#player_-1 .captures')[0].get('text').toInt(),
            '1': $$('#player_1 .captures')[0].get('text').toInt()
        }
    }

    function setCaptures(captures) {
        $$('#player_-1 .captures')[0].set('text', captures['-1'])
            .setStyle('opacity', captures['-1'] == 0 ? 0 : .7)
        $$('#player_1 .captures')[0].set('text', captures['1'])
            .setStyle('opacity', captures['1'] == 0 ? 0 : .7)
    }

    function getCurrentPlayer() {
        return $$('.currentplayer')[0].get('src') == '../img/ui/blacktoplay.png' ? 1 : -1
    }

    function setCurrentPlayer(sign) {
        $$('.currentplayer').set('src', sign > 0 ? '../img/ui/blacktoplay.png' : '../img/ui/whitetoplay.png')
    }

    function getRootTree() {
        return getCurrentTreePosition().unpack(function(tree, index) {
            while (tree.parent != null) tree = tree.parent
            return tree
        })
    }

    function setRootTree(tree) {
        if (tree.nodes.length == 0) return

        tree.parent = null
        setCurrentTreePosition(sgf.addBoards(tree), 0)

        if ('PB' in tree.nodes[0]) setPlayerName(1, tree.nodes[0].PB[0])
        if ('PW' in tree.nodes[0]) setPlayerName(-1, tree.nodes[0].PW[0])
    }

    function setCurrentTreePosition(tree, index) {
        $('goban').store('position', new Tuple(tree, index))

        if (tree.parent != null) tree.parent.current = tree.parent.subtrees.indexOf(tree)

        setBoard(sgf.addBoard(tree, index).nodes[index].board)
        setCurrentPlayer(1)

        if ('B' in tree.nodes[index]) setCurrentPlayer(-1)
        else if ('W' in tree.nodes[index]) setCurrentPlayer(1)
        else if ('PL' in tree.nodes[index])
            setCurrentPlayer(tree.nodes[index].PL[0] == 'W' ? -1 : 1)
        else if ('HA' in tree.nodes[index] && tree.nodes[index].HA[0].toInt() >= 1)
            setCurrentPlayer(-1)
    }

    function getCurrentTreePosition() {
        return $('goban').retrieve('position')
    }

    function getBoard() {
        return $('goban').retrieve('board')
    }

    function setBoard(board) {
        if (!getBoard() || getBoard().size != board.size)
            buildBoard(board)

        setCaptures(board.captures)

        for (var x = 0; x < board.size; x++) {
            for (var y = 0; y < board.size; y++) {
                var li = $('goban').getElement('.pos_' + x + '-' + y)
                var sign = board.arrangement[li.retrieve('tuple')]
                var types = ['ghost_1', 'ghost_-1', 'circle', 'triangle',
                    'cross', 'square', 'label', 'point']

                types.each(function(x) {
                    if (li.hasClass(x)) li.removeClass(x)
                })

                if (li.retrieve('tuple') in board.overlays) {
                    board.overlays[li.retrieve('tuple')].unpack(function(type, ghost, label) {
                        if (type != '') li.addClass(type)
                        if (ghost != 0) li.addClass('ghost_' + ghost)
                        if (label != '') li.set('data-label', label)
                    })
                }

                if (li.hasClass('sign_' + sign)) continue

                for (var i = -1; i <= 1; i++) {
                    if (li.hasClass('sign_' + i)) li.removeClass('sign_' + i)
                }

                li.addClass('sign_' + sign)
                    .getElement('img').set('src', '../img/goban/stone_' + sign + '.png')
            }
        }

        $('goban').store('board', board)
    }

    function makeMove(vertex) {
        if (getBoard().hasVertex(vertex) && getBoard().arrangement[vertex] != 0)
            return

        var position = getCurrentTreePosition()
        var tree = position[0], index = position[1]
        var color = getCurrentPlayer() > 0 ? 'B' : 'W'

        if (getBoard().hasVertex(vertex))
            new Audio('../sound/' + Math.floor(Math.random() * 5) + '.wav').play()
        else new Audio('../sound/pass.wav').play()

        closeGameInfo()

        // Randomize shift and readjust

        var li = $$('#goban .pos_' + vertex[0] + '-' + vertex[1])
        var direction = Math.floor(Math.random() * 9)

        for (var i = 0; i < 9; i++) li.removeClass('shift_' + i)
        li.addClass('shift_' + direction)

        if (direction == 1 || direction == 5 || direction == 8) {
            // Left
            $$('#goban .pos_' + (vertex[0] - 1) + '-' + vertex[1])
                .removeClass('shift_3').removeClass('shift_7').removeClass('shift_6')
        } else if (direction == 2 || direction == 5 || direction == 6) {
            // Top
            $$('#goban .pos_' + vertex[0] + '-' + (vertex[1] - 1))
                .removeClass('shift_4').removeClass('shift_7').removeClass('shift_8')
        } else if (direction == 3 || direction == 7 || direction == 6) {
            // Right
            $$('#goban .pos_' + (vertex[0] + 1) + '-' + vertex[1])
                .removeClass('shift_1').removeClass('shift_5').removeClass('shift_8')
        } else if (direction == 4 || direction == 7 || direction == 8) {
            // Bottom
            $$('#goban .pos_' + vertex[0] + '-' + (vertex[1] + 1))
                .removeClass('shift_2').removeClass('shift_5').removeClass('shift_6')
        }

        if (tree.current == null && tree.nodes.length - 1 == index) {
            // Append move

            var node = {}
            node[color] = [sgf.vertex2point(vertex)]
            tree.nodes.push(node)

            setCurrentTreePosition(tree, tree.nodes.length - 1)
        } else {
            if (index != tree.nodes.length - 1) {
                // Search for next move

                var nextNode = tree.nodes[index + 1]
                var moveExists = color in nextNode
                    && sgf.point2vertex(nextNode[color][0]).equals(vertex)

                if (moveExists) {
                    setCurrentTreePosition(tree, index + 1)
                    return
                }
            } else {
                // Search for variation

                var variations = tree.subtrees.filter(function(subtree) {
                    return subtree.nodes.length > 0
                        && color in subtree.nodes[0]
                        && sgf.point2vertex(subtree.nodes[0][color][0]).equals(vertex)
                })

                if (variations.length > 0) {
                    setCurrentTreePosition(sgf.addBoards(variations[0]), 0)
                    return
                }
            }

            // Create variation

            var splitted = sgf.splitTree(tree, index)
            var node = {}; node[color] = [sgf.vertex2point(vertex)]
            var newtree = { nodes: [node], subtrees: [], parent: splitted, current: null }

            splitted.subtrees.push(newtree)
            splitted.current = splitted.subtrees.length - 1

            sgf.addBoard(newtree, newtree.nodes.length - 1)
            setCurrentTreePosition(newtree, 0)
        }
    }

    function positionClicked() {
        if (!getEditMode())
            makeMove(this.retrieve('tuple'))
    }

    function buildBoard(board) {
        var rows = []
        var hoshi = board.getHandicapPlacement(9)

        for (var y = 0; y < board.size; y++) {
            var ol = new Element('ol.row')

            for (var x = 0; x < board.size; x++) {
                var li = new Element('li.pos_' + x + '-' + y)
                    .store('tuple', new Tuple(x, y))
                    .addClass('shift_' + Math.floor(Math.random() * 9))
                var img = new Element('img', { src: '../img/goban/stone_0.png' })

                if (hoshi.some(function(v) { return v.equals(li.retrieve('tuple')) }))
                    li.addClass('hoshi')

                ol.adopt(li.adopt(img).addEvent('click', positionClicked))
            }

            rows.push(ol)
        }

        var alpha = 'ABCDEFGHJKLMNOPQRSTUVWXYZ'
        var coordx = new Element('ol.coordx')
        var coordy = new Element('ol.coordy')

        for (var i = 0; i < board.size; i++) {
            coordx.adopt(new Element('li', { text: alpha[i] }))
            coordy.adopt(new Element('li', { text: board.size - i }))
        }

        $('goban').empty().adopt(rows, coordx, coordy)
            .grab(coordx.clone(), 'top').grab(coordy.clone(), 'top')

        resizeBoard()
    }

    function resizeBoard() {
        var board = getBoard()
        if (!board) return

        var width = $('goban').getStyle('width').toInt()
        var height = $('goban').getStyle('height').toInt()
        var min = Math.min(width, height)
        var fieldsize = min / board.size
        console.log(fieldsize)

        $$('#goban ol').setStyle('height', fieldsize)
        $$('#goban li').setStyle('width', fieldsize).setStyle('height', fieldsize)
    }

    function showGameInfo() {
        var tree = getRootTree()
        var rootNode = tree.nodes[0]
        var info = $('info')

        info.addClass('show').getElement('input[name="name_1"]').focus()

        info.getElement('input[name="name_1"]').set('value', getPlayerName(1))
        info.getElement('input[name="name_-1"]').set('value', getPlayerName(-1))
        info.getElement('input[name="rank_1"]').set('value', 'BR' in rootNode ? rootNode.BR[0] : '')
        info.getElement('input[name="rank_-1"]').set('value', 'WR' in rootNode ? rootNode.WR[0] : '')
        info.getElement('input[name="result"]').set('value', 'RE' in rootNode ? rootNode.RE[0] : '')
        info.getElement('input[name="komi"]').set('value', 'KM' in rootNode ? rootNode.KM[0] : '')

        var size = info.getElement('input[name="size"]')
        size.set('value', 'SZ' in rootNode ? rootNode.SZ[0] : '')

        var handicap = info.getElement('select[name="handicap"]')
        if ('HA' in rootNode) handicap.selectedIndex = rootNode.HA[0].toInt() - 1
        else handicap.selectedIndex = 0

        var disabled = tree.nodes.length > 1 || tree.subtrees.length > 0
        handicap.disabled = disabled
        size.disabled = disabled
    }

    function closeGameInfo() {
        $('info').removeClass('show')
    }

    function updateGameInfo() {
        var rootNode = getRootTree().nodes[0]
        var info = $('info')

        rootNode.BR = [info.getElement('input[name="rank_1"]').get('value')]
        rootNode.WR = [info.getElement('input[name="rank_-1"]').get('value')]
        rootNode.PB = [info.getElement('input[name="name_1"]').get('value')]
        rootNode.PW = [info.getElement('input[name="name_-1"]').get('value')]
        setPlayerName(1, rootNode.PB[0])
        setPlayerName(-1, rootNode.PW[0])

        var result = info.getElement('input[name="result"]').get('value')
        rootNode.RE = [result]
        if (result == '') delete rootNode.RE

        var komi = info.getElement('input[name="komi"]').get('value').toFloat()
        rootNode.KM = [String.from(komi)]
        if (isNaN(komi)) rootNode.KM = ['0']

        var handicap = info.getElement('select[name="handicap"]').selectedIndex
        if (handicap == 0) delete rootNode.HA
        else rootNode.HA = [String.from(handicap + 1)]

        var size = info.getElement('input[name="size"]').get('value').toInt()
        rootNode.SZ = [Math.max(Math.min(String.from(size), 26), 9)]
        if (isNaN(size)) rootNode.SZ = ['19']

        if (!info.getElement('select[name="handicap"]').disabled) {
            setCurrentTreePosition(getRootTree(), 0)

            if (!('HA' in rootNode)) {
                delete rootNode.AB
            } else {
                var board = getBoard()
                var stones = board.getHandicapPlacement(rootNode.HA[0].toInt())
                rootNode.AB = []

                for (var i = 0; i < stones.length; i++) {
                    rootNode.AB.push(sgf.vertex2point(stones[i]))
                }
            }

            setCurrentTreePosition(getRootTree(), 0)
        }
    }

    function getEditMode() {
        return $('bar').hasClass('edit')
    }

    function setEditMode(editMode) {
        if (editMode) {
            $('bar').addClass('edit')
            closeGameInfo()
        } else {
            $('bar').removeClass('edit')
        }
    }

    function prepareEditTools() {
        $$('#edit a').addEvent('click', function() {
            if (!this.getParent().hasClass('selected')) {
                $$('#edit .selected').removeClass('selected')
                this.getParent().addClass('selected')
            } else if (this.getParent().hasClass('stone-tool')) {
                var img = this.getElement('img')
                var black = img.get('src') == '../img/edit/stone_1.png'
                img.set('src', black ? '../img/edit/stone_-1.png' : '../img/edit/stone_1.png')
            }
        })
    }

    /**
     * Menu
     */

    function newGame() {
        var buffer = ';GM[1]AP[' + app.getName() + ':' + app.getVersion() + ']'
        buffer += 'CA[UTF-8]PB[Black]PW[White]KM[6.5]SZ[19]'

        var tree = sgf.parse(sgf.tokenize(buffer))
        setRootTree(tree)

        if (arguments.length >= 1) {
            new Audio('../sound/newgame.wav').play()
            showGameInfo()
        }
    }

    function loadGame(filename) {
        setIsLoading(true)

        if (arguments.length == 0) {
            var result = dialog.showOpenDialog(remote.getCurrentWindow(), {
                filters: [{ name: 'SGF Files', extensions: ['sgf'] },
                          { name: 'All Files', extensions: ['*'] }]
            })

            if (result) filename = result[0]
        }

        if (filename) {
            var tree = sgf.parseFile(filename)
            if (tree.subtrees.length == 0) return
            setRootTree(tree.subtrees[0])
        }

        setIsLoading(false)
        closeGameInfo()
    }

    function saveGame() {
        setIsLoading(true)

        var result = dialog.showSaveDialog(remote.getCurrentWindow(), {
            filters: [{ name: 'SGF Files', extensions: ['sgf'] },
                      { name: 'All Files', extensions: ['*'] }]
        })

        if (result) {
            var tree = getRootTree()
            var text = '(' + sgf.tree2string(tree) + ')'

            fs.writeFile(result, text)
        }

        setIsLoading(false)
    }

    function goBack() {
        getCurrentTreePosition().unpack(function(tree, position) {
            if (position - 1 >= 0) {
                setCurrentTreePosition(tree, position - 1)
            } else if (tree.parent != null && tree.parent.nodes.length != 0) {
                setCurrentTreePosition(tree.parent, tree.parent.nodes.length - 1)
            }
        })
    }

    function goForward() {
        getCurrentTreePosition().unpack(function(tree, position) {
            if (tree.nodes.length > position + 1) {
                setCurrentTreePosition(tree, position + 1)
            } else if (tree.current != null && tree.subtrees[tree.current].nodes.length != 0) {
                setCurrentTreePosition(tree.subtrees[tree.current], 0)
            }
        })
    }

    function goToNextFork() {
        getCurrentTreePosition().unpack(function(tree, index) {
            if (index != tree.nodes.length - 1)
                setCurrentTreePosition(tree, tree.nodes.length - 1)
            else if (tree.current != null) {
                var subtree = tree.subtrees[tree.current]
                setCurrentTreePosition(subtree, subtree.nodes.length - 1)
            }
        })
    }

    function goToPreviousFork() {
        getCurrentTreePosition().unpack(function(tree, index) {
            if (tree.parent == null || tree.parent.nodes.length == 0)
                setCurrentTreePosition(tree, 0)
            else setCurrentTreePosition(tree.parent, tree.parent.nodes.length - 1)
        })
    }

    function goToBeginning() {
        var tree = getRootTree()
        if (tree.nodes.length == 0) return
        setCurrentTreePosition(tree, 0)
    }

    function goToEnd() {
        getCurrentTreePosition().unpack(function(tree, position) {
            var t = tree
            while (t.current != null) {
                t = t.subtrees[t.current]
            }
            setCurrentTreePosition(t, t.nodes.length - 1)
        })
    }

    function buildMenu() {
        var template = [
            {
                label: '&Game',
                submenu: [
                    {
                        label: '&New',
                        accelerator: 'CmdOrCtrl+N',
                        click: newGame
                    },
                    {
                        label: '&Load...',
                        accelerator: 'CmdOrCtrl+O',
                        click: function() { loadGame() }
                    },
                    // { type: 'separator' },
                    // {
                    //     label: '&Save',
                    //     accelerator: 'CmdOrCtrl+S'
                    // },
                    {
                        label: 'Save &As...',
                        accelerator: 'CmdOrCtrl+S',
                        click: function() { saveGame() }
                    },
                    { type: 'separator' },
                    {
                        label: '&Info',
                        accelerator: 'CmdOrCtrl+I',
                        click: showGameInfo
                    }
                ]
            },
            {
                label: '&Edit',
                submenu: [
                    {
                        label: 'Toggle &Edit Mode',
                        accelerator: 'CmdOrCtrl+E',
                        click: function() {
                            setEditMode(!getEditMode())
                        }
                    },
                    { type: 'separator' },
                    {
                        label: '&Stone Tool',
                        accelerator: 'CmdOrCtrl+1',
                        click: function() {
                            setEditMode(true)
                            $$('#edit .stone-tool a').fireEvent('click')
                        }
                    },
                    {
                        label: '&Cross Tool',
                        accelerator: 'CmdOrCtrl+2',
                        click: function() {
                            setEditMode(true)
                            $$('#edit .cross-tool a').fireEvent('click')
                        }
                    },
                    {
                        label: '&Triangle Tool',
                        accelerator: 'CmdOrCtrl+3',
                        click: function() {
                            setEditMode(true)
                            $$('#edit .triangle-tool a').fireEvent('click')
                        }
                    },
                    {
                        label: '&Square Tool',
                        accelerator: 'CmdOrCtrl+4',
                        click: function() {
                            setEditMode(true)
                            $$('#edit .square-tool a').fireEvent('click')
                        }
                    },
                    {
                        label: '&Circle Tool',
                        accelerator: 'CmdOrCtrl+5',
                        click: function() {
                            setEditMode(true)
                            $$('#edit .circle-tool a').fireEvent('click')
                        }
                    },
                    {
                        label: '&Label Tool',
                        accelerator: 'CmdOrCtrl+6',
                        click: function() {
                            setEditMode(true)
                            $$('#edit .label-tool a').fireEvent('click')
                        }
                    },
                    {
                        label: '&Number Tool',
                        accelerator: 'CmdOrCtrl+7',
                        click: function() {
                            setEditMode(true)
                            $$('#edit .number-tool a').fireEvent('click')
                        }
                    }
                ]
            },
            {
                label: '&Navigation',
                submenu: [
                    {
                        label: '&Back',
                        accelerator: 'Up',
                        click: goBack
                    },
                    {
                        label: '&Forward',
                        accelerator: 'Down',
                        click: goForward
                    },
                    { type: 'separator' },
                    {
                        label: 'Go To &Previous Fork',
                        accelerator: 'CmdOrCtrl+Up',
                        click: goToPreviousFork
                    },
                    {
                        label: 'Go To &Next Fork',
                        accelerator: 'CmdOrCtrl+Down',
                        click: goToNextFork
                    },
                    { type: 'separator' },
                    {
                        label: 'Go To &Beginning',
                        accelerator: 'CmdOrCtrl+Home',
                        click: goToBeginning
                    },
                    {
                        label: 'Go To &End',
                        accelerator: 'CmdOrCtrl+End',
                        click: goToEnd
                    }
                ]
            },
            {
                label: '&View',
                submenu: [
                    {
                        label: '&Fuzzy Stone Placement',
                        type: 'checkbox',
                        checked: getFuzzyStonePlacement(),
                        click: function() {
                            setFuzzyStonePlacement(!getFuzzyStonePlacement())
                        }
                    },
                    {
                        label: 'Show &Coordinates',
                        accelerator: 'CmdOrCtrl+Shift+C',
                        type: 'checkbox',
                        checked: getShowCoordinates(),
                        click: function() {
                            setShowCoordinates(!getShowCoordinates())
                            resizeBoard()
                        }
                    },
                    {
                        label: 'Show &Variations',
                        accelerator: 'CmdOrCtrl+Shift+V',
                        type: 'checkbox',
                        checked: getShowVariations(),
                        click: function() {
                            setShowVariations(!getShowVariations())
                        }
                    },
                    { type: 'separator' },
                    {
                        label: 'Show &History',
                        accelerator: 'CmdOrCtrl+H'
                    }
                ]
            },
            {
                label: '&Help',
                submenu: [
                    {
                        label: '&About Goban'
                    }
                ]
            }
        ]

        Menu.setApplicationMenu(Menu.buildFromTemplate(template))
    }

    function openHeaderMenu() {
        var template = [
            {
                label: '&Pass',
                click: function() {
                    makeMove(new Tuple(-1, -1))
                }
            },
            {
                label: '&Count...'
            },
            { type: 'separator' },
            {
                label: '&Edit',
                click: function() {
                    setEditMode(true)
                }
            },
            {
                label: '&Info',
                click: showGameInfo
            }
        ]

        menu = Menu.buildFromTemplate(template)
        menu.popup(remote.getCurrentWindow(), $('headermenu').getPosition().x, $$('header')[0].getCoordinates().top)
    }

    /**
     * Main
     */

    document.addEvent('keydown', function(e) {
        if (e.code == 123) {
            remote.getCurrentWindow().toggleDevTools()
        } else if (e.code == 116) {
            location.reload()
        } else if (e.code == 27) {
            closeGameInfo()
            setEditMode(false)
        }
    }).addEvent('mousewheel', function(e) {
        if (e.wheel < 0) goForward()
        else if (e.wheel > 0) goBack()
    }).addEvent('domready', function() {
        loadSettings()
        buildMenu()
        prepareEditTools()

        if (process.argv.length >= 2) loadGame(process.argv[1])
        else newGame()

        new Scrollbar({
            element: $('info'),
            autoshow: true,
            createElements: false
        }).create()
    })

    window.addEvent('resize', function() {
        resizeBoard()
    })
</script>

</body>
</html>
